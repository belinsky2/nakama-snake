"""
–ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Äî —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ FastAPI.

–ó–¥–µ—Å—å:
1. –°–æ–∑–¥–∞—ë—Ç—Å—è —ç–∫–∑–µ–º–ø–ª—è—Ä FastAPI
2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è CORS (—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è frontend)
3. –ü–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è —Ä–æ—É—Ç–µ—Ä—ã (endpoints)
4. –°–æ–∑–¥–∞—é—Ç—Å—è —Ç–∞–±–ª–∏—Ü—ã –≤ –ë–î –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
"""

from contextlib import asynccontextmanager

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

from app.database import create_tables
from app.routers import scores


@asynccontextmanager
async def lifespan(app: FastAPI):
    """
    Lifecycle —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    
    - –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ (startup): —Å–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—ã –≤ –ë–î
    - –ü—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ (shutdown): –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    
    –≠—Ç–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± (–≤–º–µ—Å—Ç–æ @app.on_event).
    """
    # === STARTUP ===
    print("üöÄ –ó–∞–ø—É—Å–∫ Snake Game API...")
    
    # –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—ã –≤ –ë–î (–µ—Å–ª–∏ –∏—Ö –µ—â—ë –Ω–µ—Ç)
    create_tables()
    print("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞")
    
    yield  # –ó–¥–µ—Å—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
    
    # === SHUTDOWN ===
    print("üëã –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Snake Game API...")


# –°–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä FastAPI
app = FastAPI(
    title="üêç Snake Game API",
    description="""
    API –¥–ª—è –∏–≥—Ä—ã "–ó–º–µ–π–∫–∞".
    
    ## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
    
    - üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–≥—Ä
    - üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤
    - üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–∞
    
    ## –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
    
    1. –ò–≥—Ä–∞–π –≤ –∑–º–µ–π–∫—É –Ω–∞ frontend (http://localhost:5173)
    2. –ü–æ—Å–ª–µ Game Over —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
    3. –°–º–æ—Ç—Ä–∏ —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤ –∏ —Å–≤–æ—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    """,
    version="1.0.0",
    lifespan=lifespan,
)


# === CORS (Cross-Origin Resource Sharing) ===
# 
# –ß—Ç–æ —ç—Ç–æ?
# –ë—Ä–∞—É–∑–µ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–ø—Ä–µ—â–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –¥—Ä—É–≥–æ–π –¥–æ–º–µ–Ω/–ø–æ—Ä—Ç.
# Frontend (localhost:5173) ‚Üí Backend (localhost:8000) = —Ä–∞–∑–Ω—ã–µ –ø–æ—Ä—Ç—ã!
# –ë–µ–∑ CORS –±—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã.
#
# –ß—Ç–æ –º—ã —Ä–∞–∑—Ä–µ—à–∞–µ–º:
# - origins: —Å –∫–∞–∫–∏—Ö –∞–¥—Ä–µ—Å–æ–≤ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã
# - methods: –∫–∞–∫–∏–µ HTTP –º–µ—Ç–æ–¥—ã —Ä–∞–∑—Ä–µ—à–µ–Ω—ã
# - headers: –∫–∞–∫–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å

app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:5173",      # Vite dev server
        "http://localhost:3000",      # –ù–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –¥—Ä—É–≥–æ–π –ø–æ—Ä—Ç
        "http://127.0.0.1:5173",      # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∞–¥—Ä–µ—Å
        "http://127.0.0.1:3000",
    ],
    allow_credentials=True,           # –†–∞–∑—Ä–µ—à–∏—Ç—å cookies
    allow_methods=["*"],              # –†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ –º–µ—Ç–æ–¥—ã (GET, POST, etc.)
    allow_headers=["*"],              # –†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
)


# –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ä–æ—É—Ç–µ—Ä —Å endpoints
# –í—Å–µ endpoints –∏–∑ scores.py –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã
app.include_router(scores.router)


# === –ö–æ—Ä–Ω–µ–≤–æ–π endpoint ===
# –ü—Ä–æ—Å—Ç–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç

@app.get("/")
async def root():
    """
    –ö–æ—Ä–Ω–µ–≤–æ–π endpoint ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ.
    """
    return {
        "message": "üêç Snake Game API",
        "docs": "http://localhost:8000/docs",
        "health": "http://localhost:8000/api/health",
    }
